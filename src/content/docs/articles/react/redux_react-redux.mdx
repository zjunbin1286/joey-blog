---
title: Redux+React-Redux æœ€æ–°å…¥é—¨å®æˆ˜æŒ‡å—ğŸ’¥
---
import { FileTree } from '@astrojs/starlight/components';

:::tip[å‰è¨€]
æœ¬æ–‡å°†ç»™å¤§å®¶å¸¦æ¥reduxå’Œreact-reduxçš„å¿«é€Ÿä½¿ç”¨ï¼Œä»¥ç†è®º+ä»£ç +æ¡ˆä¾‹çš„å½¢å¼æ•™å¤§å®¶å¦‚ä½•åœ¨reactä¸­å»ä½¿ç”¨çŠ¶æ€ç®¡ç†ï¼Œä»¥å®ç°æ•°æ®çš„é«˜æ•ˆé€šä¿¡ğŸš€

å¦‚æœæœ¬æ–‡æœ‰ä¸å¯¹ã€ç–‘æƒ‘çš„åœ°æ–¹ï¼Œæ¬¢è¿åœ¨è¯„è®ºåŒºç•™è¨€æŒ‡æ­£ğŸŒ»

**é•¿æ–‡é¢„è­¦**ï¼š æœ¬æ–‡æ–‡å­—ä»£ç è¾ƒå¤šï¼Œè¯·è€å¿ƒè§‚çœ‹ï¼Œç›¸ä¿¡ä½ ä¼šæœ‰æ‰€æ”¶è·ğŸº
:::

## ä¸€ã€ä»€ä¹ˆæ˜¯ redux
`Redux` æ˜¯ `JavaScript` çŠ¶æ€å®¹å™¨ï¼Œæä¾›å¯é¢„æµ‹åŒ–çš„çŠ¶æ€ç®¡ç†ã€‚å¯ä»¥ç†è§£ä¸ºå…¨å±€æ•°æ®çŠ¶æ€ç®¡ç†å·¥å…·ï¼Œç”¨æ¥åšç»„ä»¶é€šä¿¡ç­‰ã€‚

## äºŒã€ä¸ºä»€ä¹ˆä½¿ç”¨ redux
å½“æ²¡æœ‰ä½¿ç”¨ `redux` æ—¶å…„å¼Ÿç»„ä»¶é—´ä¼ å€¼å°†å¾ˆéº»çƒ¦ï¼Œä»£ç å¾ˆå¤æ‚å†—ä½™ã€‚ä½¿ç”¨ `redux` å®šä¹‰å…¨å±€å•ä¸€çš„æ•°æ® `Store`ï¼Œå¯ä»¥è‡ªå®šä¹‰ `Store` é‡Œé¢å­˜æ”¾å“ªäº›æ•°æ®ï¼Œæ•´ä¸ªæ•°æ®ç»“æ„ä¹Ÿæ˜¯è‡ªå·±æ¸…æ¥šçš„ã€‚

## ä¸‰ã€å®‰è£… redux
```shell
yarn add redux -S 
```

## å››ã€redux å·¥ä½œæµç¨‹
ç›´æ¥ä¸Šå›¾

![image1.png](../../../../assets/react/redux_react-redux/image1.png)

## äº”ã€reduxçš„ä¸‰ä¸ªæ ¸å¿ƒæ¦‚å¿µ

### 1. action æ•°æ®æ›´æ–°çš„æŒ‡ä»¤

1. åŠ¨ä½œçš„å¯¹è±¡
2. åŒ…å«2ä¸ªå±æ€§
   * typeï¼šæ ‡è¯†å±æ€§, å€¼ä¸ºå­—ç¬¦ä¸², å”¯ä¸€, å¿…è¦å±æ€§ 
   * dataï¼šæ•°æ®å±æ€§, å€¼ç±»å‹ä»»æ„, å¯é€‰å±æ€§

3. ä¾‹å­ï¼š`{ type: 'ADD_STUDENT['](),data:{name: 'tom',age:18}}`

### 2. reducer æ“ä½œçŠ¶æ€çš„çº¯å‡½æ•°

1. ç”¨äºåˆå§‹åŒ–çŠ¶æ€ã€åŠ å·¥çŠ¶æ€
2. åŠ å·¥æ—¶ï¼Œæ ¹æ®æ—§çš„ state å’Œ actionï¼Œ äº§ç”Ÿæ–°çš„ state çš„**çº¯å‡½æ•°**ã€‚

### 3. store æ¨é€æ•°æ®çš„ä»“åº“

1. å°† stateã€actionã€reducer è”ç³»åœ¨ä¸€èµ·çš„å¯¹è±¡

2. å¦‚ä½•å¾—åˆ°æ­¤å¯¹è±¡?
```jsx
// å¼•å…¥ legacy_createStore ç”¨äºåˆ›å»º store
import { legacy_createStore as createStore } from "redux";

// å¼•å…¥ reducer
import count_reducer from './reducer'

// åˆ›å»º store å¹¶æš´éœ²
export default createStore(reducer)
```

3. æ­¤å¯¹è±¡çš„åŠŸèƒ½?
	* **getState()**: å¾—åˆ°state
	* **dispatch(action)**: åˆ†å‘action, è§¦å‘reducerè°ƒç”¨, äº§ç”Ÿæ–°çš„state
	* **subscribe(listener)**: æ³¨å†Œç›‘å¬, å½“äº§ç”Ÿäº†æ–°çš„stateæ—¶, è‡ªåŠ¨è°ƒç”¨




## å…­ã€ redux çš„æ ¸å¿ƒAPI

**1. createstore()**

ä½œç”¨ï¼šåˆ›å»ºåŒ…å«æŒ‡å®šreducerçš„storeå¯¹è±¡

**2. storeå¯¹è±¡**

1. ä½œç”¨: redux åº“æœ€æ ¸å¿ƒçš„ç®¡ç†å¯¹è±¡
2. å®ƒå†…éƒ¨ç»´æŠ¤ç€ï¼šstateã€reducer

**3. æ ¸å¿ƒæ–¹æ³•**

* getState() - è·å–æ•°æ®
* dispatch(action) - æ´¾å‘é€šçŸ¥æ”¹å˜æ•°æ®
* subscribe(listener) - ç›‘å¬ redux ä¸­çŠ¶æ€çš„å˜åŒ–ï¼Œåªè¦ä¸€å‘ç”Ÿå˜åŒ–ï¼Œå°±è°ƒç”¨ render

**4. applyMiddleware()**

ä½œç”¨ï¼šåº”ç”¨ä¸ŠåŸºäºreduxçš„ä¸­é—´ä»¶(æ’ä»¶åº“)

**5. combineReducers()**

ä½œç”¨ï¼šåˆå¹¶å¤šä¸ªreducerå‡½æ•°




## ä¸ƒã€redux çš„ä¸‰å¤§åŸåˆ™
### 1. å•ä¸€æ•°æ®æº

* æ•´ä¸ªåº”ç”¨ç¨‹åºçš„ state è¢«å­˜å‚¨åœ¨ä¸€é¢— object tree ä¸­, å¹¶ä¸”è¿™ä¸ª object tree åªå­˜å‚¨åœ¨ä¸€ä¸ª store
* Redux å¹¶æ²¡æœ‰å¼ºåˆ¶è®©æˆ‘ä»¬ä¸èƒ½åˆ›å»ºå¤š ä¸ªStoreï¼Œä½†æ˜¯é‚£æ ·åšå¹¶ä¸åˆ©äºæ•°æ®çš„ç»´æŠ¤
* å•ä¸€çš„æ•°æ®æºå¯ä»¥è®©æ•´ä¸ªåº”ç”¨ç¨‹åºçš„stateå˜å¾—æ–¹ä¾¿ç»´æŠ¤ã€è¿½è¸ªã€ä¿®æ”¹


### 2. Stateæ˜¯åªè¯»çš„

* **å”¯ä¸€ä¿®æ”¹ state çš„æ–¹æ³•ä¸€å®šæ˜¯è§¦å‘ action**, ä¸è¦è¯•å›¾åœ¨å…¶å®ƒçš„åœ°æ–¹é€šè¿‡ä»»ä½•çš„æ–¹å¼æ¥ä¿®æ”¹ state
* è¿™æ ·å°±ç¡®ä¿äº† View æˆ–ç½‘ç»œè¯·æ±‚éƒ½ä¸èƒ½ç›´æ¥ä¿®æ”¹ stateï¼Œå®ƒä»¬åªèƒ½**é€šè¿‡ action æ¥æè¿°è‡ªå·±æƒ³è¦å¦‚ä½•ä¿®æ”¹ state**
* è¿™æ ·å¯ä»¥ä¿è¯æ‰€æœ‰çš„ä¿®æ”¹éƒ½è¢«é›†ä¸­åŒ–å¤„ç†ï¼Œå¹¶ä¸”æŒ‰ç…§ä¸¥æ ¼çš„é¡ºåºæ¥æ‰§è¡Œï¼Œæ‰€ä»¥ä¸éœ€è¦æ‹…å¿ƒ race condition (ç«Ÿæ€)çš„é—®é¢˜


### 3. ä½¿ç”¨çº¯å‡½æ•°æ¥æ‰§è¡Œä¿®æ”¹

* é€šè¿‡ reducer å°†æ—§ state å’Œ action è”ç³»åœ¨ä¸€èµ·, å¹¶ä¸”è¿”å›ä¸€ä¸ªæ–°çš„ state
* éšç€åº”ç”¨ç¨‹åºçš„å¤æ‚åº¦å¢åŠ ï¼Œæˆ‘ä»¬å¯ä»¥å°† reducer æ‹†åˆ†æˆå¤šä¸ªå°çš„ reducersï¼Œåˆ†åˆ«æ“ä½œä¸åŒ state tree çš„ä¸€éƒ¨åˆ†
* ä½†æ˜¯æ‰€æœ‰çš„ reducer éƒ½åº”è¯¥æ˜¯çº¯å‡½æ•°ï¼Œä¸èƒ½äº§ç”Ÿä»»ä½•çš„å‰¯ä½œç”¨




## å…«ã€redux ä½¿ç”¨æ­¥éª¤

### 1.  åŸºæœ¬æµç¨‹

**(1) åˆ›å»ºreducer**

- å¯ä»¥ä½¿ç”¨å•ç‹¬çš„ä¸€ä¸ª reducer,ä¹Ÿå¯ä»¥å°†å¤šä¸ªreduceråˆå¹¶ä¸ºä¸€ä¸ª reducerï¼Œå³ï¼š`combineReducers()`
- action å‘å‡ºå‘½ä»¤åå°† state æ”¾å…¥ reucer åŠ å·¥å‡½æ•°ä¸­ï¼Œè¿”å›æ–°çš„ state ,å¯¹ stat eè¿›è¡ŒåŠ å·¥å¤„ç†

**(2) åˆ›å»ºaction**
- ç”¨æˆ·æ˜¯æ¥è§¦ä¸åˆ° state çš„ï¼Œåªèƒ½æœ‰ view è§¦å‘ï¼Œæ‰€ä»¥ï¼Œè¿™ä¸ª action å¯ä»¥ç†è§£ä¸ºæŒ‡ä»¤ï¼Œéœ€è¦å‘å‡ºå¤šå°‘åŠ¨ä½œå°±æœ‰å¤šå°‘æŒ‡ä»¤
- action æ˜¯ä¸€ä¸ªå¯¹è±¡ï¼Œå¿…é¡»æœ‰ä¸€ä¸ªå« type çš„å‚æ•°ï¼Œå®šä¹‰ action ç±»å‹

**(3) åˆ›å»ºçš„storeï¼Œä½¿ç”¨ legacy_createStore æ–¹æ³•**

- store å¯ä»¥ç†è§£ä¸ºæœ‰å¤šä¸ªåŠ å·¥æœºå™¨çš„æ€»å·¥å‚
- æä¾› subscribeï¼Œdispatchï¼ŒgetState è¿™äº›æ–¹æ³•ã€‚


### 2. ä¸‹é¢ç”¨ redux ç¼–å†™è®¡æ•°å™¨çš„æ¡ˆä¾‹ï¼ˆå¼‚æ­¥actionç‰ˆï¼‰

**æ³¨æ„**ï¼šå¤§éƒ¨åˆ†æ³¨é‡Šéƒ½åœ¨ä»£ç ä¸­ï¼Œå°éƒ¨åˆ†ä¼šå¦åšè¯´æ˜

**src æœ‰ä»¥ä¸‹æ–‡ä»¶**
<FileTree>
- component
	- Count
		- index.jsx
- redux
	- constant.js
	- count_action.js
	- count_reducer.js
	- store.js
- App.jsx
- index.js
</FileTree>

**å…·ä½“ä»£ç å®ç°ï¼š**

`redux/constant.js`ï¼Œ
è¯¥æ¨¡å—ç”¨äºå®šä¹‰ action å¯¹è±¡ä¸­ type ç±»å‹çš„å¸¸é‡å€¼ï¼Œæ–¹ä¾¿ç»´æŠ¤ï¼Œé˜²æ­¢å†™é”™å•è¯
```jsx
// ! è¯¥æ¨¡å—ç”¨äºå®šä¹‰ action å¯¹è±¡ä¸­ type ç±»å‹çš„å¸¸é‡å€¼ï¼Œæ–¹ä¾¿ç»´æŠ¤ï¼Œé˜²æ­¢å†™é”™å•è¯

// åŠ æ³•çš„å¸¸é‡
export const INCREMENT = 'increment'  
```

``redux/count_aciton.js``ï¼Œè¯¥æ–‡ä»¶ä¸“é—¨ä¸º Count ç»„ä»¶ç”Ÿæˆ action å¯¹è±¡
```js
// !è¯¥æ–‡ä»¶ä¸“é—¨ä¸º Count ç»„ä»¶ç”Ÿæˆ action å¯¹è±¡

// å¼•å…¥type ç±»å‹çš„å¸¸é‡
import { INCREMENT } from './constant.js'

// å®šä¹‰ action 
export const incrementAction = data => ({ type: INCREMENT, data})

// å¼‚æ­¥ actionï¼Œå°±æ˜¯æŒ‡ action çš„å€¼ä¸ºå‡½æ•°ï¼Œå¼‚æ­¥ action ä¸­ä¸€èˆ¬ä¼šè°ƒç”¨åŒæ­¥ actionï¼Œå¼‚æ­¥ actionä¸æ˜¯å¿…é¡»è¦ç”¨çš„
export const incrementAsyncAction = (data, time) => {
  // storeçš„dispatchæ–¹æ³•ä¼šåˆ¤æ–­ ä¼ å…¥å€¼æ˜¯å‡½æ•°è¿˜æ˜¯å¯¹è±¡ï¼Œå¦‚æœæ˜¯å‡½æ•°ï¼Œé‚£å°±ç»™è¿™ä¸ªå‡½æ•°ä¼ å‚æ•°ï¼Œ
  // å‚æ•°æ˜¯storeçš„dispatchæ–¹æ³•å¹¶ä¸”æ‰§è¡Œè¿™ä¸ªå‡½æ•°
  return (dispatch) => {
    setTimeout(() => {
      dispatch(createIncrementAction(data))
    }, time)
  }
}
```
``reduce/count_reducer.js``ï¼Œè¯¥æ–‡ä»¶ç”¨äºåˆ›å»ºä¸€ä¸ªä¸º Count ç»„ä»¶æœåŠ¡çš„ reducer
```js
/**
 * ! 1. è¯¥æ–‡ä»¶ç”¨äºåˆ›å»ºä¸€ä¸ªä¸º Count ç»„ä»¶æœåŠ¡çš„ reducerï¼Œreducer çš„æœ¬è´¨å°±æ˜¯ä¸€ä¸ªå‡½æ•°
 * * 2. reducer å‡½æ•°ä¼šæ¥æ”¶åˆ°ä¸¤ä¸ªå‚æ•°ï¼Œåˆ†åˆ«ä¸ºï¼šä¹‹å‰çš„çŠ¶æ€(perState)ï¼ŒåŠ¨ä½œå¯¹è±¡(action)
 * * 3. reducer å…¶å®å°±æ˜¯ç”¨äºåˆå§‹åŒ–æ•°æ®ï¼Œæ“ä½œæ•°æ®çš„é€»è¾‘çš„å‡½æ•°
 */

// å¼•å…¥å¸¸é‡
import { INCREMENT } from './constant.js'

// åˆå§‹åŒ–çŠ¶æ€
const initState = 0;

// å®šä¹‰ reducer å¹¶æš´éœ²å‡ºå»
export default function countReducer(preState = initState, action) {
  // è·å–typeï¼Œdata
  const { type, data } = action 
  switch (type) {
    case INCREMENT: // å¦‚æœæ˜¯åŠ 
      return preState + data
    default:
      return preState;
  }
}
```

``reduce/store.js``ï¼Œè¯¥æ–‡ä»¶ç”¨äºåˆ›å»º store å¯¹è±¡

**æ³¨æ„**: redux-thunk éœ€è¦å®‰è£…  `yarn add --save redux-thunk`
```js
// å¼•å…¥ redux-thunkï¼Œç”¨äºæ”¯æŒå¼‚æ­¥ action
import thunk from 'redux-thunk'
// redux-thunk æ˜¯ä¸ªä¸­é—´ä»¶ï¼Œå¿…é¡»å¼•å…¥ applyMiddleware
import { legacy_createStore as createStore, applyMiddleware } from "redux";
// å¼•å…¥ reducer
import count_reducer from './count_reducer'

// å®‰è£…ä¸­é—´ä»¶ applyMiddleware(thunk)
export default createStore(count_reducer, applyMiddleware(thunk))
```



`component/Count/index.jsx`

```jsx
import React, { Component } from 'react'
import store from '../../redux/store'

// å¼•å…¥action
import { incrementAction, incrementAsyncAction } from '../../redux/count_action'

/**
 * store çš„å‡ ä¸ª API
 * store.getState() è·å–çŠ¶æ€çš„æ•°æ®
 * store.dispatch() é€šçŸ¥ reduce æ›´æ–°çŠ¶æ€ï¼Œå‚æ•°æ˜¯ä¸ªå¯¹è±¡
 * store.subscribe() ç›‘å¬çŠ¶æ€å‘ç”Ÿå˜åŒ–åˆ™æ‰§è¡Œçš„å›è°ƒ
 */

export default class Count extends Component {

  // å¦‚ä½•è°ƒç”¨ renderï¼Ÿ
  // ç¬¬ä¸€ç§æ–¹æ³•ï¼šåœ¨ç»„ä»¶æŒ‚è½½å®Œæˆä¹‹åï¼Œè°ƒç”¨ subscribe() APIï¼Œè°ƒç”¨æ›´æ–°stateçš„æ–¹æ³•ï¼Œthis.setState({})
  componentDidMount() {
    // æ£€æµ‹ redux ä¸­çŠ¶æ€çš„å˜åŒ–ï¼Œåªè¦ä¸€å‘ç”Ÿå˜åŒ–ï¼Œå°±è°ƒç”¨ render
    store.subscribe(() => {
      this.setState({})
    })
  }

  // åŠ æ³•
  increment = () => {
    store.dispatch(incrementAction(1))
  }

   // å¼‚æ­¥åŠ 
  incrementAsync = () => {
    const { value } = this.selectNumber
    setTimeout(() => {
      store.dispatch(incrementAsyncAction(1))
    }, 500);
  }
  
  render() {
    return (
      <div>
        <h1>å½“å‰æ±‚å’Œä¸ºï¼š{store.getState()}</h1>
        <button onClick={this.increment}>+</button>&nbsp;
        <button onClick={this.incrementAsync}>å¼‚æ­¥åŠ </button>
      </div>
    )
  }
}

```

**App.jsx**

```jsx
import React, { Component } from 'react'
import Count from './components/Count'

export default class App extends Component {
  render() {
    return (
      <div>
        <Count/>
      </div>
    )
  }
}

```

**index.js**

```js
import { createRoot } from 'react-dom/client'
import App from './App'
import store from './redux/store'

const root = createRoot(document.getElementById('root'))
root.render(<App />)

// ç¬¬äºŒç§æ–¹æ³•ï¼šåœ¨çŠ¶æ€å‘ç”Ÿå˜åŒ–åˆ™æ‰§è¡Œçš„å›è°ƒä¸­ï¼Œé‡æ–°æ¸²æŸ“App
store.subscribe(() => {
  root.render(<App/>)
})
```

### 3. æ€»ç»“

1. **redux/constant.js** - æä¾› type å¸¸é‡
2. **redux/count_action.js** - ç›¸å½“äºæŒ‡ä»¤ï¼Œå¯ä»¥é€šè¿‡ `store.dispatch(action(data))` é€šçŸ¥ reduce æ›´æ–°çŠ¶æ€
3. **redux/count_reducer.js** - åˆå§‹åŒ–æ•°æ®ï¼Œæ“ä½œæ•°æ®çš„é€»è¾‘çš„å‡½æ•°
4. **redux/store.js** - ç»´æŠ¤çŠ¶æ€

## ä¹ã€å®‰è£… react-redux

```shell
yarn add react-redux
```

## åã€ä»€ä¹ˆæ˜¯ react-reduxï¼Ÿ

* `react-Redux` æ˜¯ `Redux`çš„å®˜æ–¹ `React` ç»‘å®šåº“ã€‚å®ƒèƒ½å¤Ÿä½¿ä½ çš„ `React` ç»„ä»¶ä» `Redux store` ä¸­è¯»å–æ•°æ®ï¼Œå¹¶ä¸”å‘ `store ` åˆ†å‘ `actions` ä»¥æ›´æ–°æ•°æ®
* ç®€å•åœ°è¯´ï¼Œå°±æ˜¯ä¸“é—¨ç”¨æ¥ç®€åŒ– react åº”ç”¨ä¸­ä½¿ç”¨ redux

**çœ‹å›¾è¯´è¯**


![image2.png](../../../../assets/react/redux_react-redux/image2.png)

## åä¸€ã€react-Redux å°†æ‰€æœ‰ç»„ä»¶åˆ†æˆä¸¤å¤§ç±»

### 1. UI ç»„ä»¶
* è´Ÿè´£ UI çš„å‘ˆç°ï¼Œä¸å¸¦æœ‰ä»»ä½•ä¸šåŠ¡é€»è¾‘
* é€šè¿‡propsæ¥æ”¶æ•°æ®(ä¸€èˆ¬æ•°æ®å’Œå‡½æ•°)
* ä¸ä½¿ç”¨ä»»ä½• Redux çš„ API
* ä¸€èˆ¬ä¿å­˜åœ¨ components æ–‡ä»¶å¤¹ä¸‹

### 2. å®¹å™¨ç»„ä»¶ 
* è´Ÿè´£ç®¡ç†æ•°æ®å’Œä¸šåŠ¡é€»è¾‘ï¼Œä¸è´Ÿè´£UIçš„å‘ˆç°
* ä½¿ç”¨ Redux çš„ API
* ä¸€èˆ¬ä¿å­˜åœ¨containers æ–‡ä»¶å¤¹ä¸‹



## åäºŒã€react-redux çš„ä¸¤ä¸ªæ ¸å¿ƒ

### 1. Provider

**è¯´æ˜ï¼š** Provider æ˜¯é¡¶çº§ç»„ä»¶ï¼Œä¸€èˆ¬æˆ‘ä»¬éƒ½å°†é¡¶å±‚ç»„ä»¶åŒ…è£¹åœ¨ Provider ç»„ä»¶ä¹‹ä¸­ï¼Œè¿™æ ·çš„è¯ï¼Œæ‰€æœ‰ç»„ä»¶å°±éƒ½å¯ä»¥åœ¨react-reduxçš„æ§åˆ¶ä¹‹ä¸‹äº†ï¼Œ**ä½†æ˜¯ store å¿…é¡»ä½œä¸ºå‚æ•°æ”¾åˆ° Provider ç»„ä»¶ä¸­å»**

**index.js æ–‡ä»¶ä¸­**

```jsx
import { createRoot } from 'react-dom/client'
import App from './App'
// å¼•å…¥ Provider ç»„ä»¶
import { Provider } from 'react-redux'
// å¼•å…¥ store
import store from './redux/store'

const root = createRoot(document.getElementById('root'))
root.render(
  // * ä¼˜åŒ–ä¸€ï¼šåœ¨æ•´ä¸ªåº”ç”¨é‡Œé¢ï¼Œä½†å‡¡éœ€è¦ store çš„å®¹å™¨ç»„ä»¶ï¼ŒProvider ç»„ä»¶éƒ½ä¼šä¼ é€’è¿‡å»
  // * ä½¿ç”¨ Provider åŒ…è£¹ Appï¼Œç›®çš„æ˜¯è®© Appæ‰€æœ‰çš„åä»£å®¹å™¨ç»„ä»¶éƒ½èƒ½æ¥æ”¶åˆ° store
  <Provider store={store}>
    <App />
  </Provider>
)
```



### 2. connect

**è¯´æ˜ï¼š** ç”¨äºåŒ…è£… UI ç»„ä»¶ç”Ÿæˆå®¹å™¨ç»„ä»¶

```jsx
// å¼•å…¥ connect ç”¨äºè¿æ¥ UI ç»„ä»¶ä¸ redux
import { connect } from 'react-redux'

// ä½¿ç”¨ connect()() åˆ›å»ºå¹¶æš´éœ²ä¸€ä¸ª Count çš„å®¹å™¨ç»„ä»¶
export default connect(
    mapStateToProps, 
    mapDispatchToProps
)(MyComponent)
```

#### 2.1 mapStateToProps

**è¯´æ˜ï¼š** è¿™ä¸ªå•è¯ç¿»è¯‘è¿‡æ¥å°±æ˜¯**æŠŠ state æ˜ å°„åˆ° props ä¸­å»** ,å…¶å®ä¹Ÿå°±æ˜¯**æŠŠ Redux ä¸­çš„æ•°æ®æ˜ å°„åˆ° React ä¸­çš„propsä¸­å»ã€‚**

```jsx
// 1. mapStateToProps å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡
// 2. å‡½æ•°è¿”å›çš„å¯¹è±¡ä¸­çš„å±æ€§å€¼ï¼Œå°±ä½œä¸ºä¼ é€’ç»™UIç»„ä»¶propsçš„å±æ€§å€¼
// 3. mapStateToProps ç”¨äºä¼ é€’ 'çŠ¶æ€'
// é»˜è®¤æ¥æ”¶ä¸€ä¸ª state å‚æ•°ï¼Œå€¼ä¸º count_reducer é‡Œé¢åˆå§‹åŒ–çš„å€¼
function mapStateToProps(state) {
  // è¿™é‡Œä¼ é€’äº† countï¼Œæ‰€ä»¥UIç»„ä»¶æ¥æ”¶çš„å°±æ˜¯ï¼šthis.props.count
  return {count: state}
}
```

#### 2.2 mapDispatchToProps

**è¯´æ˜ï¼š** è¿™ä¸ªå•è¯ç¿»è¯‘è¿‡æ¥å°±æ˜¯å°±æ˜¯**æŠŠå„ç§ dispatch ä¹Ÿå˜æˆäº† props è®©ä½ å¯ä»¥ç›´æ¥ä½¿ç”¨**

```jsx
import {
  incrementAction,
} from '../../redux/count_action'

// 1. æ“ä½œçŠ¶æ€çš„æ–¹æ³•
// 2. mapDispatchToProps å‡½æ•°è¿”å›çš„æ˜¯ä¸€ä¸ªå¯¹è±¡
// 3. å‡½æ•°è¿”å›çš„å¯¹è±¡ä¸­çš„å±æ€§å€¼ï¼Œå°±ä½œä¸ºä¼ é€’ç»™UIç»„ä»¶propsçš„å±æ€§å€¼
// 4. mapStateToProps ç”¨äºä¼ é€’ 'æ“ä½œçŠ¶æ€çš„æ–¹æ³•'
// é»˜è®¤æ¥æ”¶ dispatch æ–¹æ³•
function mapDispatchToProps(dispatch) {
  // è¿™é‡Œä¼ é€’äº† incrementï¼Œæ‰€ä»¥UIç»„ä»¶æ¥æ”¶çš„å°±æ˜¯ï¼šthis.props.increment(data)
  return {
    // è¿™é‡Œå¯ä»¥æ¥æ”¶åˆ°çš„å‚æ•°ï¼Œä¸ºè°ƒç”¨æ˜¯ä¼ é€’çš„æ•°æ®
    increment: number => dispatch(incrementAction(number)),
  }
}
```

### 3. connect çš„ç®€å†™

ç›´æ¥å°†  `mapStateToProps`,  `mapDispatchToProps` å†™åœ¨ connect é‡Œé¢

```jsx
import React, { Component } from 'react'
// å¼•å…¥ connect ç”¨äºè¿æ¥ UI ç»„ä»¶ä¸ redux
import { connect } from 'react-redux'
// å¼•å…¥action
import { increment } from '../../redux/actions/count.js'

// 1. å®šä¹‰ UI ç»„ä»¶
class Count extends Component {
    ...
}
    
// 2. ä½¿ç”¨ connect()() åˆ›å»ºå¹¶æš´éœ²ä¸€ä¸ª Count çš„å®¹å™¨ç»„ä»¶
export default connect(
  // æ˜ å°„çŠ¶æ€ï¼Œstate å°±æ˜¯ react-reduxä¿å­˜çš„çŠ¶æ€
  // state.count: è¿™ä¸ª count æ˜¯ store.js ä¸­ï¼Œæ±‡æ€» reducer æ—¶å®šä¹‰çš„ key
  state => ({
    count: state.count,
  }),
  
  // mapDispatchToProps çš„ç®€å†™
  {
    // ç›´æ¥æ˜ å°„ actionï¼Œreact-redux ä¼šå¸®ä½  dispatch
    increment,
    decrement,
    incrementAsync
  }
)(Count)
```



## åä¸‰ã€react-redux æ±‚å’Œæ¡ˆä¾‹

**è¯´æ˜ï¼š** è¯¥æ¡ˆä¾‹æ˜¯ redux æ­é… react-redux å®ç°çš„ä¸€ä¸ªæ±‚å’Œçš„ç®€å•éœ€æ±‚ï¼Œå®ç°äº†ä¸¤ä¸ªç»„ä»¶é—´çš„æ•°æ®å…±äº«ï¼ˆè¯·æŸ¥çœ‹ä»£ç ä¸­æ³¨é‡Šè¿›è¡Œç†è§£ï¼‰

### 1. src æ–‡ä»¶ç»“æ„

<FileTree>
- containers
	- Count
		- index.jsx
	- Person
		- index.jsx
- redux
  - actions
    - count.js
    - person.js
  - reducers
    - count.js
    - person.js
    - index.js
  - constant.js
  - store.js
- App.jsx
- index.js
</FileTree>

### 2. redux æ–‡ä»¶å¤¹

**2.1 constant.js**

```js
// !è¯¥æ¨¡å—ç”¨äºå®šä¹‰ action å¯¹è±¡ä¸­ type ç±»å‹çš„å¸¸é‡å€¼
// count
export const INCREMENT = 'increment'  

// person
export const ADD_PERSON = 'add_person'
```



**2.2 actions/count.js**

```js
// !è¯¥æ–‡ä»¶ä¸“é—¨ä¸º Count ç»„ä»¶ç”Ÿæˆ action å¯¹è±¡

// å¼•å…¥å¸¸é‡
import { INCREMENT, DECREMENT} from '../constant'

// åŠ æ³•action
export const increment = data => ({ type: INCREMENT, data })

```

**actions/person.js**

```js
// å¼•å…¥ type å¸¸é‡
import { ADD_PERSON } from '../constant'

// å®šä¹‰ action å¹¶å¯¼å‡º
export const addPerson = personObj => ({type: ADD_PERSON , data: personObj})
```



**2.3 reducers/count.js**

```js
// å¼•å…¥å¸¸é‡
import { INCREMENT } from '../constant'

// åˆå§‹åŒ–çŠ¶æ€
const initState = 0;
export default function countReducer(preState = initState, action) {
  // è·å–typeï¼Œdata
  const { type, data } = action 
  switch (type) {
    case INCREMENT: // å¦‚æœæ˜¯åŠ 
    default:
      return preState;
  }
}
```

**reducers/person.js**

```js
// å¼•å…¥ type å¸¸é‡
import { ADD_PERSON } from '../constant'

// åˆå§‹åŒ–çŠ¶æ€
const initState = [{id: '001', name: 'coderbin', age: 18}]

// å®šä¹‰ reducerï¼Œå¹¶æš´éœ²å‡ºå»
export default function personReducer(preState = initState, action) {
  const { type, data } = action

  switch (type) {
    // å¦‚æœæ˜¯æ·»åŠ ä¸€ä¸ªäººï¼Œå°±æ‰§è¡Œç›¸å…³çš„é€»è¾‘æ“ä½œ
    case ADD_PERSON:
      // ! ä¸å¯å†™ä¸‹é¢è¿™ä¸€è¡Œä»£ç ï¼Œè¿™æ ·ä¼šå¯¼è‡´ preState è¢«æ”¹å†™ï¼ŒpersonReducer å°±ä¸æ˜¯çº¯å‡½æ•°äº†
      // preState.unshift(data)
      // æ³¨æ„ï¼šåªæœ‰è¿”å›çš„æ˜¯ä¸€ä¸ªæ–°æ•°ç»„ï¼Œreactæ‰ä¼šè¿›è¡Œæ¸²æŸ“ï¼Œæ›´æ–°é¡µé¢ 
      return [data, ...preState]
  
    default:
      return preState
  }
}

```

**reducers/index.js**  ç»Ÿä¸€åœ¨è¿™é‡Œå¯¼å‡ºæ€» reducer

```js
// !è¯¥æ–‡ä»¶ç”¨äºæ±‡æ€»æ‰€æœ‰çš„ reducer ä¸ºä¸€ä¸ªæ€»çš„ reducer

// å¼•å…¥ reducer
import count from './count.js'
import persons from './person.js'

// å¼•å…¥ combineReducersï¼Œè¿›è¡Œæ±‡æ€»
import { combineReducers } from "redux";

// * ä½¿ç”¨ combineReducers() æ±‡æ€»æ‰€æœ‰çš„ reducerï¼Œå˜æˆä¸€ä¸ªæ€»çš„ reducer
export default combineReducers({
  count,
  persons
})

```

**2.4 store.js**

```js
// ! è¯¥æ–‡ä»¶ç”¨äºåˆ›å»ºä¸€ä¸ª react-redux ä»“åº“

// å¼•å…¥ redux-thunkï¼Œç”¨äºæ”¯æŒå¼‚æ­¥ action
import thunk from 'redux-thunk'
// redux-thunk æ˜¯ä¸ªä¸­é—´ä»¶ï¼Œå¿…é¡»å¼•å…¥ applyMiddleware
import { legacy_createStore as createStore, applyMiddleware } from "redux";
// å¼•å…¥ redux-devtools-extension
import { composeWithDevTools } from 'redux-devtools-extension'

// å¼•å…¥æ±‡æ€»åçš„ reducer
import allReducer from '../redux/reducers/index.js'

// åˆ›å»ºä¸€ä¸ª store å¹¶å¯¼å‡º
// composeWithDevTools ç”¨äºæ¿€æ´» redux å¼€å‘è€…å·¥å…·
// å®‰è£…ä¸­é—´ä»¶ applyMiddleware(thunk)
export default createStore(allReducer, composeWithDevTools(applyMiddleware(thunk)))
```

**æ³¨æ„ï¼š** redux-devtools-extension æ˜¯ reduxçš„å¼€å‘è€…å·¥å…·åº“ï¼Œéœ€è¦å®‰è£…

```shell
yarn add redux-devtools-extension
```

### 3. containers æ–‡ä»¶å¤¹

**Count/index.jsx**

```jsx

import React, { Component } from 'react'
// å¼•å…¥ connect ç”¨äºè¿æ¥ UI ç»„ä»¶ä¸ redux
import { connect } from 'react-redux'
// å¼•å…¥action
import {
  increment,
  decrement,
  incrementAsync
} from '../../redux/actions/count.js'

// 1. å®šä¹‰ UI ç»„ä»¶
class Count extends Component {

  // åŠ æ³•
  increment = () => {
    const { value } = this.selectNumber
    // è°ƒç”¨ props é‡Œé¢çš„æ–¹æ³•ï¼Œè¿›è¡ŒåŠ å‡
    this.props.increment(Number(value))
  }

  render() {
    const { count } = this.props
    return (
      <div>
        <h1>æˆ‘æ˜¯Countç»„ä»¶</h1>
        <h3>å½“å‰æ±‚å’Œä¸ºï¼š{count}</h3>
        <h2>ã€æ‹¿åˆ°Personç»„ä»¶æ•°æ®ï¼šæ€»äººæ•°ä¸º: { this.props.persons.length}ã€‘</h2>
        <button onClick={this.increment}>+</button>
      </div>
    )
  }
}


// 2. ä½¿ç”¨ connect()() åˆ›å»ºå¹¶æš´éœ²ä¸€ä¸ª Count çš„å®¹å™¨ç»„ä»¶
export default connect(
  // æ˜ å°„çŠ¶æ€ï¼Œstate å°±æ˜¯ react-reduxä¿å­˜çš„çŠ¶æ€
  state => ({
    count: state.count,
    persons: state.persons
  }),
  {
    // ç›´æ¥æ˜ å°„ actionï¼Œreact-redux ä¼šå¸®ä½  dispatch
    increment,
    decrement,
    incrementAsync
  }
)(Count)
```

**Person/index.jsx**

```jsx
import React, { Component } from 'react'
import { nanoid } from 'nanoid'
import { connect } from 'react-redux'
import { addPerson } from '../../redux/actions/person.js'

class Person extends Component {
  // æ·»åŠ 
  addPerson = () => {
    const name = this.nameRef.value.trim()
    const age = Number(this.ageRef.value.trim())
    if(!name || !age) return alert('è¯·è¾“å…¥ï¼')
    const personObj = { id: nanoid(), name, age }
    this.props.addPerson(personObj)
    this.nameRef.value = ''
    this.ageRef.value = ''
  }

  render() {
    return (
      <div>
        <h1>æˆ‘æ˜¯Personç»„ä»¶</h1>
        <h2>ã€æ‹¿åˆ°Countç»„ä»¶çš„æ•°æ®ï¼šæ±‚å’Œä¸º: { this.props.count}ã€‘</h2>
        <input ref={c=>this.nameRef=c} type="text" placeholder='è¯·è¾“å…¥å§“å'/>
        <input ref={c=>this.ageRef=c} type="text" placeholder='è¯·è¾“å…¥å¹´é¾„' />
        <button onClick={this.addPerson}>æ·»åŠ </button>
        <ul>
          {
            this.props.persons.map(item => {
              return <li key={item.id}>{ item.name} -- { item.age }</li>
            })
          }
        </ul>
      </div>
    )
  }
}

export default connect(
  // å½“å‰ç»„ä»¶éœ€è¦ä»€ä¹ˆæ•°æ®ï¼ˆçŠ¶æ€ï¼‰ï¼Œå°±ä»è¿™é‡Œæ˜ å°„ä»€ä¹ˆæ•°æ®ï¼ˆçŠ¶æ€ï¼‰
  state => ({
    persons: state.persons,
    count: state.count
  }),
  { addPerson }
)(Person)
```

### 4. App.jsx

```jsx
import React, { Component } from 'react'
// å¼•å…¥å®¹å™¨ç»„ä»¶
import Count from './containers/Count' 
import Person from './containers/Person'

export default class App extends Component {
  render() {
    return (
      <div>
        <Count/>
        <hr />
        <Person/>
      </div>
    )
  }
}

```

### 5. index.js

```jsx
import { createRoot } from 'react-dom/client'
import App from './App'
// å¼•å…¥ Provider ç»„ä»¶
import { Provider } from 'react-redux'
// å¼•å…¥ store
import store from './redux/store'

const root = createRoot(document.getElementById('root'))
root.render(
  <Provider store={store}>
    <App />
  </Provider>
)
```

### 6. æ€»ç»“

åœ¨ä½¿ç”¨ **react-redux** å‰ï¼Œè¦å…ˆç¼–å†™ redux çš„å†…å®¹ï¼Œç„¶åå†å»å®Œæˆ UI ç»„ä»¶

UIç»„ä»¶çš„ç¼–å†™æ­¥éª¤
```
(1).å®šä¹‰å¥½UIç»„ä»¶---ä¸æš´éœ²

(2).å¼•å…¥connectç”Ÿæˆä¸€ä¸ªå®¹å™¨ç»„ä»¶ï¼Œå¹¶æš´éœ²ï¼Œå†™æ³•å¦‚ä¸‹ï¼š

   connect(
		state => ({key:value}), //æ˜ å°„çŠ¶æ€
		{key:xxxxxAction} //æ˜ å°„æ“ä½œçŠ¶æ€çš„æ–¹æ³•
	)(UIç»„ä»¶)

(4).åœ¨UIç»„ä»¶ä¸­é€šè¿‡this.props.xxxxxxxè¯»å–å’Œæ“ä½œçŠ¶æ€
```



## åå››ã€çº¯å‡½æ•°å’Œé«˜é˜¶å‡½æ•°

### 1. çº¯å‡½æ•°

1. ä¸€ç±»ç‰¹åˆ«çš„å‡½æ•°: åªè¦æ˜¯åŒæ ·çš„è¾“å…¥(å®å‚)ï¼Œå¿…å®šå¾—åˆ°åŒæ ·çš„è¾“å‡º(è¿”å›)
2. å¿…é¡»éµå®ˆä»¥ä¸‹ä¸€äº›çº¦æŸ
   * ä¸å¾—æ”¹å†™å‚æ•°æ•°æ®
   * ä¸ä¼šäº§ç”Ÿä»»ä½•å‰¯ä½œç”¨ï¼Œä¾‹å¦‚ç½‘ç»œè¯·æ±‚ï¼Œè¾“å…¥å’Œè¾“å‡ºè®¾å¤‡
   * ä¸èƒ½è°ƒç”¨ `Date.now()` æˆ–è€… `Math.random()` ç­‰ä¸çº¯çš„æ–¹æ³•
3. reduxçš„reducerå‡½æ•°å¿…é¡»æ˜¯ä¸€ä¸ªçº¯å‡½æ•°

### 2. é«˜é˜¶å‡½æ•°
1. ç†è§£: ä¸€ç±»ç‰¹åˆ«çš„å‡½æ•°
   * æƒ…å†µä¸€ï¼šå‚æ•°æ˜¯å‡½æ•°
   * æƒ…å†µäºŒï¼šè¿”å›å€¼æ˜¯å‡½æ•°
2. å¸¸è§çš„é«˜é˜¶å‡½æ•°
   * å®šæ—¶å™¨å›è°ƒå‡½æ•°
   * æ•°ç»„çš„ forEach()/map()/filter()/reduce()/find()/bind()
   * Promise
   * react-redux ä¸­çš„ connect å‡½æ•°
3. ä½œç”¨: èƒ½å®ç°æ›´åŠ åŠ¨æ€, æ›´åŠ å¯æ‰©å±•çš„åŠŸèƒ½

> æ¯æ–‡ä¸€å¥ï¼šè™šå‡çš„å­¦é—®æ¯”æ— çŸ¥æ›´ç³Ÿç³•ã€‚æ— çŸ¥å¥½æ¯”ä¸€å—ç©ºåœ°ï¼Œå¯ä»¥è€•è€˜å’Œæ’­ç§ï¼›è™šå‡çš„å­¦é—®å°±è±¡ä¸€å—é•¿æ»¡æ‚è‰çš„è’åœ°ï¼Œå‡ ä¹æ— æ³•æŠŠè‰æ‹”å°½ã€‚
